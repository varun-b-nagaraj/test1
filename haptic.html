<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Xbox Haptics</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: #fafafa;
    color: #333;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  
  .container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 40px;
    width: 500px;
    max-width: 90vw;
  }
  
  .title {
    text-align: center;
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 30px;
    color: #222;
  }
  
  .status {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 30px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ddd;
    transition: all 0.3s ease;
  }
  
  .status-dot.connected { background: #28a745; }
  .status-dot.no-haptics { background: #ffc107; }
  
  .status-text {
    font-size: 14px;
    color: #666;
  }
  
  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 30px;
  }
  
  .control {
    text-align: center;
  }
  
  .control-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 500;
  }
  
  .control-value {
    font-size: 32px;
    font-weight: 700;
    color: #222;
    margin-bottom: 4px;
  }
  
  .control-unit {
    font-size: 12px;
    color: #999;
    margin-bottom: 16px;
  }
  
  .control-hint {
    font-size: 11px;
    color: #999;
    padding: 4px 8px;
    background: #f1f3f4;
    border-radius: 4px;
    display: inline-block;
  }
  
  .buttons {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .btn {
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    background: #f8f9fa;
    border-color: #ccc;
  }
  
  .btn:active {
    transform: scale(0.98);
  }
  
  .btn-primary {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }
  
  .btn-primary:hover {
    background: #0056b3;
    border-color: #0056b3;
  }
  
  .btn-danger {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
  }
  
  .btn-danger:hover {
    background: #c82333;
    border-color: #c82333;
  }
  
  .instructions {
    font-size: 12px;
    color: #666;
    text-align: center;
    line-height: 1.4;
  }
  
  .key {
    background: #f1f3f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
    font-size: 11px;
  }
  
  .running {
    border: 2px solid #28a745;
  }
  
  .debug {
    margin-top: 16px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    font-family: monospace;
    font-size: 11px;
    color: #666;
    text-align: center;
  }
</style>
</head>
<body>
<div class="container" id="container">
  <h1 class="title">Xbox Haptics</h1>
  
  <div class="status">
    <div class="status-dot" id="statusDot"></div>
    <div class="status-text" id="statusText">Connect controller and press any button</div>
  </div>
  
  <div class="controls">
    <div class="control">
      <div class="control-label">Intensity</div>
      <div class="control-value" id="intensityValue">60</div>
      <div class="control-unit">percent</div>
      <div class="control-hint">D-pad ↑↓</div>
    </div>
    
    <div class="control">
      <div class="control-label">Frequency</div>
      <div class="control-value" id="frequencyValue">3.2</div>
      <div class="control-unit" id="frequencyUnit">Hz</div>
      <div class="control-hint">D-pad ←→</div>
    </div>
  </div>
  
  <div class="buttons">
    <button class="btn" id="detectBtn">Detect</button>
    <button class="btn btn-primary" id="startBtn">Start</button>
    <button class="btn btn-danger" id="stopBtn">Stop</button>
  </div>
  
  <div class="instructions">
    Press <span class="key">B</span> to toggle • 
    <span class="key">D-pad ↑↓</span> intensity • 
    <span class="key">D-pad ←→</span> frequency
  </div>
  
  <div class="debug" id="debug">Ready</div>
</div>

<script>
(() => {
  const elements = {
    container: document.getElementById('container'),
    statusDot: document.getElementById('statusDot'),
    statusText: document.getElementById('statusText'),
    intensityValue: document.getElementById('intensityValue'),
    frequencyValue: document.getElementById('frequencyValue'),
    frequencyUnit: document.getElementById('frequencyUnit'),
    detectBtn: document.getElementById('detectBtn'),
    startBtn: document.getElementById('startBtn'),
    stopBtn: document.getElementById('stopBtn'),
    debug: document.getElementById('debug')
  };

  const state = {
    controllerIndex: null,
    isRunning: false,
    animationId: null,
    intensity: 60, // 0-100
    frequency: 25, // 0-101 position
    lastButtons: null,
    lastInputTime: 0
  };

  // Frequency conversion
  function posToHz(pos) {
    if (pos >= 101) return Infinity;
    const norm = pos / 101;
    return 200 * (1 - Math.pow(1 - norm, 3));
  }

  function getGamepads() {
    return navigator.getGamepads ? Array.from(navigator.getGamepads()).filter(Boolean) : [];
  }

  function hasHaptics(gp) {
    return gp?.vibrationActuator && typeof gp.vibrationActuator.playEffect === 'function';
  }

  function findController() {
    const pads = getGamepads();
    for (let i = 0; i < pads.length; i++) {
      const gp = pads[i];
      if (gp?.connected && gp.mapping === 'standard' && hasHaptics(gp)) {
        return { gamepad: gp, index: i, hasHaptics: true };
      }
    }
    for (let i = 0; i < pads.length; i++) {
      const gp = pads[i];
      if (gp?.connected && hasHaptics(gp)) {
        return { gamepad: gp, index: i, hasHaptics: true };
      }
    }
    for (let i = 0; i < pads.length; i++) {
      const gp = pads[i];
      if (gp?.connected) {
        return { gamepad: gp, index: i, hasHaptics: false };
      }
    }
    return null;
  }

  function updateStatus() {
    const found = findController();
    
    if (!found) {
      elements.statusDot.className = 'status-dot';
      elements.statusText.textContent = 'Connect controller and press any button';
    } else if (found.hasHaptics) {
      elements.statusDot.className = 'status-dot connected';
      elements.statusText.textContent = 'Controller connected - haptics ready';
    } else {
      elements.statusDot.className = 'status-dot no-haptics';
      elements.statusText.textContent = 'Controller connected - no haptics';
    }
  }

  function updateDisplay() {
    elements.intensityValue.textContent = state.intensity;
    
    const hz = posToHz(state.frequency);
    if (hz === Infinity) {
      elements.frequencyValue.textContent = '∞';
      elements.frequencyUnit.textContent = 'constant';
    } else {
      elements.frequencyValue.textContent = hz.toFixed(1);
      elements.frequencyUnit.textContent = 'Hz';
    }
  }

  function readButtons(gp) {
    if (!gp || !gp.buttons) return null;
    
    const buttons = gp.buttons;
    return {
      B: buttons[1]?.pressed || false,
      DPAD_UP: buttons[12]?.pressed || false,
      DPAD_DOWN: buttons[13]?.pressed || false,
      DPAD_LEFT: buttons[14]?.pressed || false,
      DPAD_RIGHT: buttons[15]?.pressed || false
    };
  }

  function sendHaptics(intensity, duration) {
    const pads = getGamepads();
    const gp = pads[state.controllerIndex];
    if (!gp?.vibrationActuator) return;
    
    const strength = intensity / 100;
    gp.vibrationActuator.playEffect('dual-rumble', {
      startDelay: 0,
      duration: Math.max(20, duration),
      strongMagnitude: strength,
      weakMagnitude: strength
    }).catch(() => {});
  }

  function stopHaptics() {
    const pads = getGamepads();
    const gp = pads[state.controllerIndex];
    if (!gp?.vibrationActuator) return;
    
    if (typeof gp.vibrationActuator.reset === 'function') {
      gp.vibrationActuator.reset().catch(() => {});
    } else {
      sendHaptics(0, 50);
    }
  }

  function hapticsLoop(timestamp) {
    if (!state.isRunning) {
      state.animationId = null;
      return;
    }
    
    const pads = getGamepads();
    const gp = pads[state.controllerIndex];
    if (!gp?.connected || !gp.vibrationActuator) {
      stop();
      updateStatus();
      return;
    }
    
    const hz = posToHz(state.frequency);
    const time = timestamp / 1000;
    let amplitude;
    
    if (hz === Infinity) {
      amplitude = state.intensity;
    } else if (hz <= 0) {
      amplitude = 0;
    } else {
      const sine = 0.5 + 0.5 * Math.sin(2 * Math.PI * hz * time);
      amplitude = state.intensity * Math.max(0.1, sine);
    }
    
    sendHaptics(amplitude, 25);
    state.animationId = requestAnimationFrame(hapticsLoop);
  }

  function start() {
    const found = findController();
    if (!found || !found.hasHaptics) {
      updateStatus();
      alert('No controller with haptics found');
      return;
    }
    
    state.controllerIndex = found.index;
    state.isRunning = true;
    elements.container.classList.add('running');
    
    if (!state.animationId) {
      state.animationId = requestAnimationFrame(hapticsLoop);
    }
  }

  function stop() {
    state.isRunning = false;
    elements.container.classList.remove('running');
    
    if (state.animationId) {
      cancelAnimationFrame(state.animationId);
      state.animationId = null;
    }
    
    stopHaptics();
  }

  function toggle() {
    state.isRunning ? stop() : start();
  }

  function pollController() {
    const found = findController();
    if (!found) {
      updateStatus();
      state.lastButtons = null;
      elements.debug.textContent = 'No controller';
      return;
    }
    
    updateStatus();
    
    const buttons = readButtons(found.gamepad);
    if (!buttons) return;
    
    const prev = state.lastButtons;
    
    // B button toggle (only on press, not hold)
    if (buttons.B && !(prev?.B)) {
      toggle();
    }
    
    // D-pad controls (continuous while held)
    const now = performance.now();
    const dt = Math.min((now - state.lastInputTime) / 1000, 0.1); // cap at 100ms
    state.lastInputTime = now;
    
    // Intensity: D-pad up/down
    if (buttons.DPAD_UP) {
      state.intensity = Math.min(100, state.intensity + 100 * dt);
      updateDisplay();
    }
    if (buttons.DPAD_DOWN) {
      state.intensity = Math.max(0, state.intensity - 100 * dt);
      updateDisplay();
    }
    
    // Frequency: D-pad left/right
    if (buttons.DPAD_RIGHT) {
      state.frequency = Math.min(101, state.frequency + 50 * dt);
      updateDisplay();
    }
    if (buttons.DPAD_LEFT) {
      state.frequency = Math.max(0, state.frequency - 50 * dt);
      updateDisplay();
    }
    
    state.lastButtons = buttons;
    
    elements.debug.textContent = 
      `Intensity: ${state.intensity.toFixed(0)}% | ` +
      `Frequency: ${elements.frequencyValue.textContent}${elements.frequencyUnit.textContent} | ` +
      `${state.isRunning ? 'Running' : 'Stopped'}`;
  }

  // Event listeners
  elements.detectBtn.addEventListener('click', updateStatus);
  elements.startBtn.addEventListener('click', start);
  elements.stopBtn.addEventListener('click', stop);

  window.addEventListener('gamepadconnected', updateStatus);
  window.addEventListener('gamepaddisconnected', () => {
    stop();
    updateStatus();
  });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stop();
  });

  // Initialize
  updateDisplay();
  updateStatus();
  
  // Poll controller at 60fps
  setInterval(pollController, 16);
})();
</script>
</body>
</html>